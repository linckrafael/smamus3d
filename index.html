<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estacionamento SMAMUS - 3D</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h2 { margin: 20px 0 10px; text-align: center; color: #333; }
    #contador { margin-bottom: 15px; font-weight: bold; color: #555; }

    .wrapper { width: 100%; max-width: 1100px; padding: 10px; display: flex; justify-content: center; }
    #estacionamento { position: relative; width: 100%; height: 650px; border: 2px solid #333; border-radius: 10px; overflow: hidden; background:#e9edf3; }

    #admin-access-container { position: fixed; top: 10px; right: 10px; z-index: 1000; }
    .admin-buttons-centered {
      display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
      margin-bottom: 20px; width: 100%; max-width: 1100px;
    }
    .button-style {
      padding: 8px 12px; font-size: 14px; cursor: pointer; border: none; border-radius: 8px;
      color: white; background-color: #3CB371; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background-color 0.2s ease, transform 0.15s ease;
    }
    .button-style:hover { background-color: #008000; transform: translateY(-1px); }
    .hidden { display: none !important; }

    .legenda {
      margin-top: 16px; display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; text-align: center;
    }
    .legenda-item { display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .legenda-icon { width: 24px; height: 24px; border-radius: 5px; border: 1px solid #000; background-size: cover; background-position: center; }
    .livre { background-color: rgba(0, 200, 0, 0.5); }
    .ocupada { background-color: rgba(200,0,0,0.7); }
    .especial-livre { background-color: rgba(0, 0, 200, 0.5); }
    .especial-ocupada { background-color: #d3d3d3; }

    @media (max-width: 600px) {
      .legenda { flex-direction: column; gap: 10px; }
      #admin-access-container { position: static; margin-top: 10px; margin-bottom: 10px; text-align: center; }
      .admin-buttons-centered { margin-bottom: 10px; }
      .button-style { font-size: 12px; padding: 6px 8px; }
      #estacionamento { height: 500px; }
    }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>Estacionamento SMAMUS (3D)</h2>
  <div id="contador">Total: 0 | Ocupadas: 0 | Livres: 0</div>

  <div id="admin-access-container">
    <button id="admin-mode-btn" class="button-style">Modo Administrador</button>
  </div>

  <div id="admin-buttons-wrapper" class="admin-buttons-centered hidden">
    <button id="user-mode-btn" class="button-style">Modo Usu√°rio</button>
    <button id="selecionar-todas" class="admin-button button-style hidden">Selecionar Todas</button>
    <button id="deselecionar-todas" class="admin-button button-style hidden">Limpar Todas</button>
    <button id="criar-vaga" class="admin-button button-style hidden">Criar Vaga</button>
    <button id="apagar-vaga" class="admin-button button-style hidden">Apagar Vaga</button>
    <button id="mover-vaga" class="admin-button button-style hidden">Mover/Rotacionar</button>
  </div>

  <div class="wrapper"><div id="estacionamento"></div></div>

  <div class="legenda">
    <div class="legenda-item"><div class="legenda-icon livre"></div><span>Vaga Livre</span></div>
    <div class="legenda-item"><div class="legenda-icon ocupada"></div><span>Vaga Ocupada</span></div>
    <div class="legenda-item"><div class="legenda-icon especial-livre"></div><span>Vaga Especial Livre</span></div>
    <div class="legenda-item"><div class="legenda-icon especial-ocupada"></div><span>Vaga Especial Ocupada</span></div>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/controls/OrbitControls.js';
    import { TransformControls } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/controls/TransformControls.js';

    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDvgoGXBnFZbXi28SuSnQlx8mIN6Ebsflk",
      authDomain: "estacionamentosmamus.firebaseapp.com",
      databaseURL: "https://estacionamentosmamus-default-rtdb.firebaseio.com",
      projectId: "estacionamentosmamus",
      storageBucket: "estacionamentosmamus.appspot.com",
      messagingSenderId: "864410096092",
      appId: "1:864410096092:web:c8f039da393d4130bb7f19",
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const vagasRef = database.ref('vagas');

    const contador = document.getElementById('contador');
    const adminAccessBtn = document.getElementById('admin-mode-btn');
    const adminButtonsWrapper = document.getElementById('admin-buttons-wrapper');
    const allAdminButtons = adminButtonsWrapper.querySelectorAll('button');
    const userModeBtn = document.getElementById('user-mode-btn');
    let isAdminMode = false;
    let isMoveMode = false;
    let selectedAction = null;
    const adminPassword = "admin123";
    let vagas = [];
    let vagaMeshes = new Map();

    function toggleAdminButtonsWrapper(show) {
      if (show) adminButtonsWrapper.classList.remove('hidden');
      else adminButtonsWrapper.classList.add('hidden');
    }
    function toggleIndividualAdminButtons(show) {
      allAdminButtons.forEach(button => {
        if (button.id === 'user-mode-btn') button.classList.remove('hidden');
        else show ? button.classList.remove('hidden') : button.classList.add('hidden');
      });
    }

    // --- Three.js ---
    const container3D = document.getElementById('estacionamento');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f2f5);

    const camera = new THREE.PerspectiveCamera(60, container3D.clientWidth / container3D.clientHeight, 0.1, 2000);
    camera.position.set(80, 80, 80);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(container3D.clientWidth, container3D.clientHeight);
    container3D.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.target.set(0, 0, 0);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.9);
    dirLight.position.set(120, 180, 120);
    scene.add(dirLight);

    const PLANE_SIZE = 100;
    const planeGeo = new THREE.PlaneGeometry(PLANE_SIZE, PLANE_SIZE);
    const planeMat = new THREE.MeshStandardMaterial({ color: 0xdddddd });
    const plane = new THREE.Mesh(planeGeo, planeMat);
    plane.rotation.x = -Math.PI / 2;
    scene.add(plane);

    const loader = new GLTFLoader();
    loader.load('est v2.glb', gltf => {
      scene.add(gltf.scene);
    });

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const transformControls = new TransformControls(camera, renderer.domElement);
    transformControls.setMode('translate');
    transformControls.addEventListener('dragging-changed', e => controls.enabled = !e.value);
    scene.add(transformControls);

    const MATERIALS = {
      livre: new THREE.MeshStandardMaterial({ color: 0x22aa22 }),
      ocupada: new THREE.MeshStandardMaterial({ color: 0xaa2222 }),
      especialLivre: new THREE.MeshStandardMaterial({ color: 0x2244aa }),
      especialOcupada: new THREE.MeshStandardMaterial({ color: 0xaaaaaa })
    };
    const vagaGeo = new THREE.BoxGeometry(3.5, 0.2, 1.8);
    const labelGeo = new THREE.PlaneGeometry(2.2, 0.8);

    function makeLabelTexture(text) {
      const c = document.createElement('canvas');
      const ctx = c.getContext('2d');
      c.width = 256; c.height = 128;
      ctx.fillStyle = 'rgba(0,0,0,0.6)';
      ctx.fillRect(0, 0, 256, 128);
      ctx.font = 'bold 64px Arial';
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(text, 128, 64);
      return new THREE.CanvasTexture(c);
    }

    function vagaMaterialFor(v) {
      const esp = (v.id === 'V15' || v.id === 'V16');
      if (v.ocupada) return esp ? MATERIALS.especialOcupada : MATERIALS.ocupada;
      return esp ? MATERIALS.especialLivre : MATERIALS.livre;
    }
    function toPlaneCoords(left, top) {
      return {
        x: (left/100)*PLANE_SIZE - PLANE_SIZE/2,
        z: (1-top/100)*PLANE_SIZE - PLANE_SIZE/2
      };
    }

    function upsertVaga3D(v) {
      let entry = vagaMeshes.get(v.id);
      const material = vagaMaterialFor(v);
      if (!entry) {
        const mesh = new THREE.Mesh(vagaGeo, material);
        const labelMat = new THREE.MeshBasicMaterial({ map: makeLabelTexture(v.id), transparent: true });
        const labelMesh = new THREE.Mesh(labelGeo, labelMat);
        labelMesh.position.y = 1.0;
        const group = new THREE.Group();
        group.userData.vagaId = v.id;
        group.add(mesh); group.add(labelMesh);
        scene.add(group);
        vagaMeshes.set(v.id, { group, mesh, labelMesh, labelMat });
        entry = vagaMeshes.get(v.id);
      } else {
        entry.mesh.material = material;
        entry.labelMat.map = makeLabelTexture(v.ocupada ? '' : v.id);
        entry.labelMat.needsUpdate = true;
      }
      const pos = toPlaneCoords(v.left ?? 10, v.top ?? 10);
      entry.group.position.set(pos.x, 0.1, pos.z);
      entry.group.rotation.y = (v.rotate ?? 0) * Math.PI/180;
      entry.labelMesh.visible = !v.ocupada;
    }

    vagasRef.on('value', snap => {
      const data = snap.val() || {};
      vagas = Object.keys(data).map(k => ({ id: k, ...data[k] }));
      vagas.forEach(upsertVaga3D);
      contador.textContent = `Total: ${vagas.length} | Ocupadas: ${vagas.filter(v=>v.ocupada).length} | Livres: ${vagas.filter(v=>!v.ocupada).length}`;
    });

    renderer.domElement.addEventListener('click', e => {
      const rect = renderer.domElement.getBoundingClientRect();
      mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects([...vagaMeshes.values()].map(o=>o.group), true);
      if (intersects.length) {
        const vId = intersects[0].object.parent.userData.vagaId;
        if (isAdminMode && !isMoveMode) {
          const v = vagas.find(x=>x.id===vId);
          if (v) vagasRef.child(vId).update({ ocupada: !v.ocupada });
        }
      }
    });

    adminAccessBtn.addEventListener('click', () => {
      if (prompt("Senha:") === adminPassword) {
        isAdminMode = true;
        adminAccessBtn.classList.add('hidden');
        toggleAdminButtonsWrapper(true);
        toggleIndividualAdminButtons(true);
      }
    });
    userModeBtn.addEventListener('click', () => {
      isAdminMode = false;
      isMoveMode = false;
      adminAccessBtn.classList.remove('hidden');
      toggleAdminButtonsWrapper(false);
    });

    document.getElementById('selecionar-todas').addEventListener('click', () => {
      vagas.forEach(v => vagasRef.child(v.id).update({ ocupada: true }));
    });
    document.getElementById('deselecionar-todas').addEventListener('click', () => {
      vagas.forEach(v => vagasRef.child(v.id).update({ ocupada: false }));
    });
    document.getElementById('criar-vaga').addEventListener('click', () => {
      const novaId = prompt('ID da nova vaga:');
      vagasRef.child(novaId).set({ top: 50, left: 50, rotate: 0, ocupada: false });
    });
    document.getElementById('apagar-vaga').addEventListener('click', () => {
      selectedAction = 'delete';
    });
    document.getElementById('mover-vaga').addEventListener('click', () => {
      isMoveMode = !isMoveMode;
    });

    window.addEventListener('resize', () => {
      camera.aspect = container3D.clientWidth / container3D.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container3D.clientWidth, container3D.clientHeight);
    });

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
